#  **BrokerChain**

## **Background**

### **1. Motivation**

​	区块链底层技术仍处于初期探索阶段，还面临着诸多问题和挑战。具体来讲，现有的区块链技术难以解决共识效率问题。例如，**比特币的吞吐量为7 TXs/s 、以太坊的吞吐量也仅为20 TXs/s**，远低于商用级别所需的吞吐量要求。因此，需要提高区块链的可扩展性，才能扩大其使用场景，从而赋能数字经济、金融保险、政务等多个领域与行业。同时，目前区块链面临三难困境，没有一种区块链可以很好的同时实现可扩展性、安全性和去中心化。

![img](https://pic4.zhimg.com/80/v2-2adc15136efc779c491b9ee9865121e7_720w.webp)

​	针对区块链的可扩展性问题，研究人员提出了多种不同的技术方案，如闪电网络、DAG技术、状态通道和分片机制。其中分片机制是目前为止最有希望在保持高度去中心化特性的同时，可提高区块链可扩展性的链上扩容技术。分片机制将区块链网络划分为若干个互不相交的分片，每个分片只存储本分片内的数据而不是完整的账本状态，从而缓解存储开销；此外，多个分片间可以并行验证交易，产生区块，实现了吞吐量的近线性提升，有效提升了全网整体的事务处理性能。

### **Challenge**

但是，区块链分片技术仍面临诸多挑战，片内共识、片间通信还有整个区块链分片协议等等方面还面临许多痛点难点，仍需要不断地进行研究和摸索。分片策略还停留在理论阶段，现有的分片方法依赖于UTXO（未使用的交易输出）或账户/余额交易模型。

而基于账户/余额模型的分片机制还存在如下挑战：

1. 跨分片交易比例过高，几乎所有交易均为跨分片交易。过高的跨分片交易率不仅给系统增加了额外的交易负载，而且会造成大量的跨分片通信开销。
2. 分片间的交易负载严重失衡，存在冷热不均的现象。我们分别称需要**处理过量和少量交易的分片为热分片（Hot Shard）和冷分片（Clod Shard）**。热分片由于被持续注入大量的交易，产生了交易拥挤的现象，这会增加交易的确认延迟。而冷分片内只有少量交易可以处理，所产生的区块的交易填充率不高，造成了算力、带宽等资源的浪费。

对如上两个问题，一个难题是如何**保证跨分片交易比例较低**的同时**保证分片间的交易负载均衡**。

文章分析了Monoxide的分片产生的热分片：
![image-20230917192006214](C:\Users\huawei\AppData\Roaming\Typora\typora-user-images\image-20230917192006214.png)

**contribution：**

1. BrokerChain 对账户状态进行分区，在协议层进行账户分割。因此，良好分区的账户状态可以由多个分片分摊，以实现所有分片之间的工作负载平衡。
2. 为了缓解热分片问题，BrokerChain 还提供了跨分片交易处理机制，可以保证跨分片交易的持续时间限制的最终原子性。
3. 我们实现了 BrokerChain 协议并在阿里云中部署了原型。通过实验和交易驱动的模拟，我们表明  BrokerChain  在吞吐量、TX 确认延迟、交易池队列大小和工作负载平衡方面优于最先进的基线。

### Monoxide

现在最先进的分片解决方案，Monoxide，实现了基于账户/余额的区块链分片协议，利用新型的中继交易机制处理跨分片TXs。但是Monoxide协议还存在如下挑战：

1. Monoxide根据账户分配机制减少TXs，根据用户账户地址的前几位划分到不同的分片中，旨在协同存储所有帐户状态。虽然这种方式可以提高系统吞吐量，但不可避免地会产生跨分片TX。
2. 通过引入接力交易（relay TXs）来确保分片交易的原子性。但是接力交易会导致分片的拥塞，大量TXs堵塞的碎片会造成热分片问题。在每个热分片中，TXs无法及时处理，可能会经历较长的确认延迟。
3. 通过消息传递机制实现跨分片交易，并保证交易的原子性。但由于跨分片中继消息验证的存在，跨分片交易的延迟在理论上至少是片内交易时延的两倍。当位于目标分片内的关联交易迟迟无法上链时，跨分片交易的共识延迟有可能无限大。

![img](https://pic4.zhimg.com/80/v2-a8c2e53f13339ccf4c104adc73375a2b_720w.webp)

## Solution

![img](https://pic1.zhimg.com/80/v2-c3aa230a51f0b2ef28da182cddf0cec0_720w.webp)

### 1. Overview

BrokerChain协议以”Epoch“（时期）为单位运行区块链系统，Epoch为固定的片内共识轮次或者固定长度的时间。

#### 1.1 Two Shard

本文采用BFT类共识协议作为片内共识协议，每个分片都通过PBFT协议来达成各自的块内共识并避免分叉。在BrokerChain中，根据职能的不同，存在两种不同类型的分片：工作分片（Mining shard，M-shard）和划分分片（Partition shard，P-shard）。它们分别负责处理不同的事务，具体分工描述如下：

- M-shard在每个Epoch期间**打包TXs**，**通过PBFT共识将合法的交易打包上链**；
- P-shard在每个Epoch期间以自适应的方式**划分账户状态**。

#### 1.2 Four sequential phases

![image-20230917202812540](C:\Users\huawei\AppData\Roaming\Typora\typora-user-images\image-20230917202812540.png)

如上图展示了本文所提出的跨分片协议的整体框架，包括4个关键步骤，具体描述如下：

1. **交易区块共识阶段**：在一个Epoch开始时，每个M-shard都会从交易池里打包TXs，并通过运行PBFT协议生成多个交易块。P-shard在一个Epoch内产生的交易块数量取决于分片内的网络参数，如带宽等。而M-shard产生的第一个新交易区块遵循状态区块（也就是图2中的 BT−1 )，记录着前一Epoch的状态划分结果。
2. **状态图分区阶段**：P-shard从产生的区块中读取交易并持续更新所有账户的账户图。一旦M-shard生成了当前Epoch中的所有TXs块，状态图就固定了。然后，根据Metis算法开始对状态图进行划分，以实现所有分片之间的负载平衡。
3. **状态区块共识阶段**：在前一阶段对所有账户的状态图进行分区后，BrokerChain将执行账户分割机制，后面会详细描述。为了对状态图分区和账户分割的结果达成共识，再次利用PBFT协议生成一个状态块（由表示 BT ），然后将其添加到划分分片链中。
4. **状态重配置阶段**：对划分结果达成共识后，P-shard广播包含S分区的状态图的状态区块到所有相关联的M-shard。当接收到状态块 BT 时，工作分片从状态块读取状态分区结果，并相应地重新配置其状态，以便可以根据新的帐户状态将下一个Epoch（第t+1个）中的交易分配到指定的分片。

### Account Segment

强制用户设立多个账户是不合理的，因此设计了一种账户分割机制（ account segmentation mechanism）。这个机制在区块链架构的协议层工作。

提出的账户分割机制具有以下优点：

1. 不强制用户开立多个帐户。
2. 用户帐户的状态可以轻松划分并存储在多个分片中。
3. 通过这种用户透明的方式，可以方便地实现所有分片的工作负载平衡，从而消除hot shrad。

如下，通过一个账户分割的例子，理解账户分割机制。假设现在有三个账户以及三笔要处理的交易。假设现在有两个分片，shard#1 和shard#2。账户A，B分别存储在两个分片中。那么不妨假设C设立在shard#2中。如果用Monoxide的分片方法，这三笔交易会产生4个跨分片交易。而如果采用BrokerChain的方法，那跨分片交易会减少到2个。

![image-20230917203519925](C:\Users\huawei\AppData\Roaming\Typora\typora-user-images\image-20230917203519925.png)

表面上看，BrokerChain好像就是把一个账户分割了成了两个账户，分配存款后放入不同的分片。但值得注意的是，这两个账户的地址是相同的。也就是说，BrokerCain协议在某个分片上存储着另一个分片上的帐户存款，并且他们具有相同的账户地址。研究者采用以太坊的计数器机制（帐户状态的nonce）来识别位于另一个分片上的帐户的多个状态。

### 3 mSST

要启用状态图分区和帐户分割操作，**BrokerChain必须强制每个分片了解所有帐户的存储映射**。因此，基于以太坊的MPT状态树设计了一种改进的**分片状态树（mSST）**，以存储帐户状态。与MPT树不同，BrokerChain的mSST构建在所有帐户的存储映射上。定义为： =[1,2,⋯,] 。

其中每个e都是一个布尔值，然后S是M-shard的数量。BrokerChain需要为每个帐户配置存储映射。 ei 为1代表这个账户的状态被分片 i 给存储了，如果在 中有多个元素被置为1，代表该账户被多个对应的分片存储了状态。

![image-20230917205254282](C:\Users\huawei\AppData\Roaming\Typora\typora-user-images\image-20230917205254282.png)

**对于某个特定的账户而言，不同的分片为这个账户维护的不同的mSST**。这些状态树的区别在于值，nonce以及代码。如果目标帐户不再存储在分片中，则这些字段与此相对应分片的MSST将被删除。而且该碎片只需要更新目标帐户的状态。目标帐户状态的任何更改都会导致MSST的状态变化。因此，很容易保持帐户状态在相关的分片中的一致性。

### **Handling cross-sharing TXs**

#### **4.1 Broker account**

尽管账户分割机制能够将一个账户细分为多个较小的账户，但问题是区块链系统需要招募一些愿意充当中介的账户，以帮助处理跨分片交易。我们称这些中介机构为做市商账户，简称为broker。

![img](https://pic1.zhimg.com/80/v2-e96fe03cd638eb213d8bdfa8f6f6b408_720w.webp)

broker的基本要求是其账户拥有足够数量的货币。对于打算成为broker的系统用户，他们可以请求将其资产抵押给受信任的第三方或特殊的智能合约。然后，BrokerChain协议为那些感兴趣的系统用户提供了代理资格。broker的状态会被系统分割成两部分或多个部分，分别存储在两个或多个分片中，从而参与到若干个跨分片TXs的协调当中。broker的协调机制可以减少基于转账类型的交易的跨分片通信，因此可以减少跨分片TXs的延迟，从而提高跨分片TXs执行的效率。

 

## **summary**

1. 提出了一种更为先进的分片技术（分片的思想是面对提交到区块链系统的所有交易（TX）时进行分而治之。分片技术不是像传统方式那样由所有区块链节点处理所有 TX，而是**将区块链节点划分为不同的较小委员会**，每个委员会只需处理 TX 的子集[1]。因此，理论上可以提高交易吞吐量。），BrokerChain 通过利用**经纪人账户**的优势来处理跨分片 TX。此外，BrokerChain通过细粒度的状态分区和账户分割机制，可以在分配交易的同时实现工作负载平衡。

















# 补充知识

#### PBFT（实用拜占庭容错）

区块链技术的核心是确保所有参与者对数据的状态达成一致，这种一致性被称为“共识”。达成共识的过程需要通过某种协议来实现，这样所有的参与者都能够同意某个数据或交易的状态。其中，PBFT（实用拜占庭容错）是一种共识算法。

PBFT 的主要优点是它能够在没有工作量证明（Proof of Work，PoW）的情况下达成共识，这使得它在某些场景中比 PoW 更为高效。PBFT 是一种拜占庭容错算法，这意味着它可以容忍系统中的**一部分节点（不超过系统总数的1/3）表现出恶意或故障行为**，而系统仍然能够正常工作。

简单来说，PBFT 的工作流程如下：

1. **请求阶段**：客户端发送请求给主节点。
2. **预准备阶段**：主节点广播该请求给所有其他节点。
3. **准备阶段**：当节点收到预准备信息后，它会广播一个准备消息给所有其他节点。
4. **提交阶段**：当节点收到足够数量的准备消息后，它会广播一个提交消息。
5. **回复阶段**：当节点收到足够数量的提交消息后，它执行该请求并将结果发送回客户端。

只有当超过2/3的节点都同意某个交易或数据状态时，该交易或数据状态才被认为是有效的。

回到您引用的论文内容，当论文提到“委员会在本地运行特定的共识协议，例如实用拜占庭容错（PBFT）”，它实际上是指这些委员会使用 PBFT 算法在本地达成关于交易集的共识。这意味着，通过分片技术，不同的委员会可以并行处理不同的交易集，从而提高整个区块链系统的吞吐量和效率。



#### UTXO（Unspent Transaction Output）

UTXO代表“未花费的交易输出”（Unspent Transaction Output）。UTXO模型是比特币和一些其他加密货币用来跟踪交易和账户余额的方法。以下是UTXO模型的基本概念和工作原理：

1. **基本概念**：
   - 在UTXO模型中，没有传统意义上的“账户”和“余额”。相反，每笔交易都会产生新的UTXO，并消耗旧的UTXO。
   - UTXO可以被视为加密货币的数字硬币或票据。每个UTXO都有一个特定的价值，并且可以被用作新交易的输入。
2. **交易的工作方式**：
   - 当用户想要发送加密货币时，他们的钱包软件会从他们控制的UTXO集合中选择一个或多个UTXO作为交易的输入。
   - 这些输入UTXO被“消费”或“花费”，并且不能再次被使用。
   - 交易还会产生新的UTXO作为输出。这些输出可以是给接收方的支付，也可以是找零，返回给发送方。
3. **示例**：
   - 假设Alice有一个价值5 BTC的UTXO，她想要发送3 BTC给Bob。
   - Alice的交易会消费这个5 BTC的UTXO，并产生两个新的UTXO作为输出：一个是3 BTC给Bob，另一个是2 BTC作为找零返回给Alice。
   - 现在，3 BTC的UTXO属于Bob，2 BTC的UTXO属于Alice。
4. **安全性和隐私**：
   - UTXO模型为交易提供了一定程度的隐私，因为每次交易都会产生新的UTXO，这使得跟踪资金流动变得更加困难。
   - 此外，由于每个UTXO只能被花费一次，这也防止了双重支付。
5. **与账户/余额模型的对比**：
   - 一些其他的加密货币，如以太坊，使用账户/余额模型而不是UTXO模型。在这种模型中，每个账户都有一个明确的余额，交易直接从一个账户转移到另一个账户，而不涉及UTXO的创建和消费。

总的来说，UTXO模型是一种独特的方式来跟踪加密货币的所有权和交易，它为比特币和其他使用此模型的加密货币提供了基础。



#### 区块链中的挖矿和交易过程

交易过程，基于POW：

1. **交易的创建**：
   - 用户创建一个交易，例如，Alice想要向Bob转账10个加密货币单位。
   - Alice的钱包软件会使用她的私钥对这笔交易进行签名，以证明这笔交易确实来自她。
2. **交易的广播**：
   - 签名的交易被广播到网络，并被全节点接收。
   - 节点验证交易，确保它是有效的（例如，确保Alice有足够的余额进行转账）。
3. **交易进入交易池**：
   - 一旦验证，交易进入所谓的“交易池”或“内存池”。这是一个临时存储区，等待矿工将交易包含到新的区块中。
4. **挖矿过程**：
   - 矿工从交易池中选择交易，通常基于交易费的大小，然后开始工作量证明（Proof of Work, PoW）的计算过程，试图找到一个满足特定条件的哈希值。
   - 一旦找到这样的哈希值，新的区块就被创建，并包含了矿工选择的交易。
5. **区块的广播**：
   - 新创建的区块被广播到网络，并被其他节点接收。
   - 节点验证新区块及其包含的所有交易。
   - 如果区块是有效的，它会被添加到节点的区块链上，并且之前在交易池中的交易会被移除。
6. **确认过程**：
   - 一旦交易被包含在一个区块中并被添加到区块链上，它就被认为是“确认”的。但为了更高的安全性，通常建议等待更多的区块被添加到该交易之后，因为这会使交易更难以被篡改或回滚。